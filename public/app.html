<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DreamCoach - Dream Analysis</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="app-container">
        <!-- Mobile Menu Button -->
        <button class="mobile-menu-btn hidden" id="mobileMenuBtn">
            <i class="material-icons">menu</i>
        </button>

        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <div class="logo-icon">
                        <i class="material-icons">psychology</i>
                    </div>
                    <h1>DreamCoach</h1>
                </div>
            </div>
            
            <nav class="nav-menu">
                <a href="#" class="nav-item active" data-page="chat">
                    <i class="material-icons">chat_bubble</i>
                    <span>Dream Analysis</span>
                </a>
                <a href="#" class="nav-item" data-page="history">
                    <i class="material-icons">history</i>
                    <span>My Dreams</span>
                </a>
                <a href="#" class="nav-item premium-feature" data-page="trends">
                    <i class="material-icons">analytics</i>
                    <span>Trend Analysis</span>
                    <span class="premium-badge">PRO</span>
                </a>
                <a href="#" class="nav-item premium-feature" data-page="bulk">
                    <i class="material-icons">upload_file</i>
                    <span>Bulk Upload</span>
                    <span class="premium-badge">PRO</span>
                </a>
            </nav>
            
            <div class="user-section">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <div>
                        <div class="user-name" id="userName">User</div>
                        <button class="logout-btn" id="logoutBtn">Sign Out</button>
                    </div>
                </div>
                
                <div class="usage-card">
                    <div class="usage-header">
                        <span class="usage-label">Dreams Analyzed</span>
                        <span class="usage-count"><span id="dreamCount">0</span> / 10</span>
                    </div>
                    <div class="usage-bar">
                        <div class="usage-fill" id="usageFill" style="width: 0%"></div>
                    </div>
                </div>
                
                <button class="upgrade-btn" id="upgradeBtn">
                    <i class="material-icons">star</i>
                    Upgrade to Premium
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Chat Page -->
            <div id="chatPage" class="page-content">
                <div class="content-header">
                    <h1 class="page-title">Dream Analysis</h1>
                </div>

                <div class="chat-container">
                    <div class="chat-messages" id="chatMessages">
                        <!-- Welcome Message -->
                        <div class="message assistant">
                            <div class="message-avatar">AI</div>
                            <div class="message-content">
                                <div class="message-text">
                                    Welcome to DreamCoach! I'm here to help you understand the deeper meanings within your dreams. Share a dream you'd like to explore, and I'll provide insights based on psychological analysis and symbolic interpretation.
                                </div>
                                <div class="message-time" id="welcomeTime"></div>
                            </div>
                        </div>
                    </div>

                    <div class="chat-input-container">
                        <form class="chat-form" id="chatForm">
                            <div class="input-wrapper">
                                <textarea 
                                    class="dream-input" 
                                    id="dreamInput"
                                    placeholder="Describe your dream in detail..."
                                    rows="1"
                                ></textarea>
                            </div>
                            <button type="submit" class="send-btn" id="sendBtn">
                                <i class="material-icons">send</i>
                                <span>Analyze</span>
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- History Page (Hidden by default) -->
            <div id="historyPage" class="page-content hidden">
                <div class="content-header">
                    <h1 class="page-title">Dream History</h1>
                </div>
                <div class="p-4">
                    <p class="text-center">Your dream history will appear here.</p>
                </div>
            </div>

            <!-- Trends Page (Hidden by default) -->
            <div id="trendsPage" class="page-content hidden">
                <div class="content-header">
                    <h1 class="page-title">Dream Trends</h1>
                </div>
                <div class="p-4">
                    <p class="text-center">Upgrade to Premium to access dream trend analysis.</p>
                </div>
            </div>

            <!-- Bulk Upload Page (Hidden by default) -->
            <div id="bulkPage" class="page-content hidden">
                <div class="content-header">
                    <h1 class="page-title">Bulk Upload</h1>
                </div>
                <div class="p-4">
                    <p class="text-center">Upgrade to Premium to upload multiple dreams at once.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer"></div>

    <script type="module" src="js/firebase-config.js"></script>
    <script type="module" src="js/chat.js"></script>
    <script type="module">
        import { auth } from './js/firebase-config.js';
        import { onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js';

        // Set welcome time
        document.getElementById('welcomeTime').textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

        // Auth state observer
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Update user info
                const userName = document.getElementById('userName');
                const userAvatar = document.getElementById('userAvatar');
                
                userName.textContent = user.displayName || user.email.split('@')[0];
                userAvatar.textContent = (user.displayName || user.email)[0].toUpperCase();
            } else {
                // Redirect to login
                window.location.href = '/';
            }
        });

        // Navigation
        const navItems = document.querySelectorAll('.nav-item');
        const pages = document.querySelectorAll('.page-content');

        navItems.forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                const page = item.dataset.page;
                
                // Update active states
                navItems.forEach(nav => nav.classList.remove('active'));
                item.classList.add('active');
                
                // Show/hide pages
                pages.forEach(p => p.classList.add('hidden'));
                const targetPage = document.getElementById(page + 'Page');
                if (targetPage) {
                    targetPage.classList.remove('hidden');
                }
                
                // Handle premium features
                if (item.classList.contains('premium-feature')) {
                    showToast('This feature is available in the Premium plan', 'warning');
                }
            });
        });

        // Mobile menu
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const sidebar = document.getElementById('sidebar');

        if (window.innerWidth <= 768) {
            mobileMenuBtn.classList.remove('hidden');
        }

        mobileMenuBtn.addEventListener('click', () => {
            sidebar.classList.toggle('open');
        });

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                await signOut(auth);
                window.location.href = '/';
            } catch (error) {
                showToast('Error signing out', 'error');
            }
        });

        // Upgrade button
        document.getElementById('upgradeBtn').addEventListener('click', () => {
            window.location.href = '/pricing.html';
        });

        // Toast function
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type} fade-in`;
            
            const icon = document.createElement('i');
            icon.className = 'material-icons toast-icon';
            icon.textContent = type === 'error' ? 'error' : type === 'success' ? 'check_circle' : 'info';
            
            const msg = document.createElement('span');
            msg.className = 'toast-message';
            msg.textContent = message;
            
            const close = document.createElement('button');
            close.className = 'toast-close';
            close.innerHTML = '<i class="material-icons">close</i>';
            close.onclick = () => toast.remove();
            
            toast.appendChild(icon);
            toast.appendChild(msg);
            toast.appendChild(close);
            
            document.getElementById('toastContainer').appendChild(toast);
            
            setTimeout(() => toast.remove(), 5000);
        }

        // Make toast function global
        window.showToast = showToast;
    </script>
</body>
</html>
