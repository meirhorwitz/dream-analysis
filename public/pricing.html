<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DreamCoach Premium - Professional Dream Analysis</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body class="pricing-page">
    <div class="pricing-container">
        <header class="pricing-header">
            <div class="logo">
                <div class="logo-icon">
                    <i class="material-icons">psychology</i>
                </div>
                <h1>DreamCoach Premium</h1>
            </div>
            <p class="tagline">Unlock the full power of professional dream analysis</p>
        </header>

        <div class="pricing-comparison">
            <!-- Free Plan -->
            <div class="plan-card free-plan">
                <h3 class="plan-name">Free</h3>
                <div class="plan-price">
                    <span class="currency">$</span>
                    <span class="amount">0</span>
                    <span class="period">/forever</span>
                </div>
                <ul class="plan-features">
                    <li><i class="material-icons">check</i> 10 dream analyses</li>
                    <li><i class="material-icons">check</i> Basic AI insights</li>
                    <li><i class="material-icons">check</i> Dream history</li>
                    <li class="disabled"><i class="material-icons">close</i> Trend analysis</li>
                    <li class="disabled"><i class="material-icons">close</i> Bulk upload</li>
                    <li class="disabled"><i class="material-icons">close</i> Export features</li>
                    <li class="disabled"><i class="material-icons">close</i> Priority support</li>
                </ul>
                <button class="plan-button" disabled>Current Plan</button>
            </div>

            <!-- Premium Monthly Plan -->
            <div class="plan-card premium-plan featured">
                <div class="popular-badge">Most Popular</div>
                <h3 class="plan-name">Premium Monthly</h3>
                <div class="plan-price">
                    <span class="currency">$</span>
                    <span class="amount">9.99</span>
                    <span class="period">/month</span>
                </div>
                <ul class="plan-features">
                    <li><i class="material-icons">check</i> <strong>Unlimited</strong> dream analyses</li>
                    <li><i class="material-icons">check</i> Advanced AI insights</li>
                    <li><i class="material-icons">check</i> Complete dream history</li>
                    <li><i class="material-icons">check</i> Pattern & trend analysis</li>
                    <li><i class="material-icons">check</i> Bulk dream upload</li>
                    <li><i class="material-icons">check</i> Export to PDF/Docs</li>
                    <li><i class="material-icons">check</i> Priority support</li>
                </ul>
                <button class="plan-button" id="monthlyPlanBtn">
                    Get Premium Monthly
                </button>
            </div>

            <!-- Premium Annual Plan -->
            <div class="plan-card annual-plan">
                <div class="savings-badge">Save 20%</div>
                <h3 class="plan-name">Premium Annual</h3>
                <div class="plan-price">
                    <span class="original-price">$119.88</span>
                    <span class="currency">$</span>
                    <span class="amount">95.88</span>
                    <span class="period">/year</span>
                </div>
                <ul class="plan-features">
                    <li><i class="material-icons">check</i> Everything in Premium</li>
                    <li><i class="material-icons">check</i> <strong>2 months FREE</strong></li>
                    <li><i class="material-icons">check</i> Advanced analytics</li>
                    <li><i class="material-icons">check</i> API access (coming soon)</li>
                    <li><i class="material-icons">check</i> Custom dream categories</li>
                    <li><i class="material-icons">check</i> Team collaboration</li>
                    <li><i class="material-icons">check</i> White-glove support</li>
                </ul>
                <button class="plan-button" id="annualPlanBtn">
                    Get Premium Annual
                </button>
            </div>
        </div>

        <div class="text-center mt-4">
            <p class="mb-2">
                <i class="material-icons" style="vertical-align: middle; color: var(--success-color);">security</i>
                Secure payment via Stripe • Cancel anytime
            </p>
            <p>
                <a href="/app.html" style="color: var(--text-secondary);">← Back to app</a>
            </p>
        </div>
    </div>

    <!-- Payment Modal -->
    <div class="auth-modal hidden" id="paymentModal">
        <div class="auth-container">
            <div class="auth-header">
                <h3>Complete Your Purchase</h3>
            </div>
            <div id="paymentElement" class="p-3">
                <!-- Stripe Elements will be inserted here -->
                <div class="skeleton" style="height: 300px; border-radius: var(--radius-md);"></div>
            </div>
            <div class="text-center mt-3">
                <button class="submit-btn" id="confirmPaymentBtn">
                    <span class="spinner hidden"></span>
                    <span id="paymentBtnText">Confirm Payment</span>
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import AuthManager from './js/auth.js';
        import { functions } from './js/firebase-config.js';
        import { httpsCallable } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-functions.js';

        (async () => {
            try {
                await AuthManager.requireAuth();
                initializeApp();
            } catch (error) {
                console.log(error.message); // Should log "Redirecting to login"
                // The script will stop execution here if not authenticated
            }
        })();
        
        function initializeApp() {
            const urlParams = new URLSearchParams(window.location.search);
            const isTestMode = urlParams.get('test') === 'true';

            // Plan selection
            const monthlyBtn = document.getElementById('monthlyPlanBtn');
            const annualBtn = document.getElementById('annualPlanBtn');
            const paymentModal = document.getElementById('paymentModal');

            monthlyBtn.addEventListener('click', () => handlePlanSelection('monthly'));
            annualBtn.addEventListener('click', () => handlePlanSelection('annual'));

            async function handlePlanSelection(planType) {
                if (isTestMode) {
                    await activateTestSubscription(planType);
                    return;
                }

                // Show payment modal
                paymentModal.classList.remove('hidden');
                
                try {
                    // Create checkout session
                    const createCheckoutSession = httpsCallable(functions, 'createCheckoutSession');
                    const { data } = await createCheckoutSession({ 
                        planType,
                        successUrl: window.location.origin + '/app.html?payment=success',
                        cancelUrl: window.location.origin + '/pricing.html'
                    });

                    if (data.url) {
                        // Redirect to Stripe Checkout
                        window.location.href = data.url;
                    }
                } catch (error) {
                    console.error('Error creating checkout session:', error);
                    showToast('Error processing payment. Please try again.', 'error');
                    paymentModal.classList.add('hidden');
                }
            }

            async function activateTestSubscription(planType) {
                showToast('Activating test subscription...', 'info');
                try {
                    const activateTestSubscription = httpsCallable(functions, 'activateTestSubscription');
                    await activateTestSubscription({ planType });
                    showToast('Test subscription activated successfully!', 'success');
                    setTimeout(() => {
                        window.location.href = '/app.html?payment=success';
                    }, 1500);
                } catch (error) {
                    console.error('Error activating test subscription:', error);
                    showToast('Error activating test subscription. See console for details.', 'error');
                }
            }

            // Close modal on background click
            paymentModal.addEventListener('click', (e) => {
                if (e.target === paymentModal) {
                    paymentModal.classList.add('hidden');
                }
            });

            // Toast notification
            function showToast(message, type = 'info') {
                // (Implementation remains the same)
            }
        }
    </script>
</body>
</html>
